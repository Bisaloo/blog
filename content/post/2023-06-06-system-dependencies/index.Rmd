---
slug: system-dependency
title: "System Dependencies in R Packages & Automatic Testing" 
authors: 
- Hugo Gruson
date: "2023-06-06" 
tags: 
- package development 
- r-package
output: hugodown::hugo_document
---

<!-- FIXME: Use this image for social media: https://pixabay.com/fr/photos/alice-anglais-pays-des-merveilles-2902560/ -->

```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.path = "", comment = "", warning = FALSE)
# knitr hook to make images output use Hugo options
knitr::knit_hooks$set(
  plot = function(x, options) {
    hugoopts <- options$hugoopts
    paste0(
      "{{<figure src=",
      '"', x, '" ',
      if (!is.null(hugoopts)) {
        glue::glue_collapse(
          glue::glue('{names(hugoopts)}="{hugoopts}"'),
          sep = " "
        )
      },
      ">}}\n"
    )
  }
)
options(crayon.enabled = FALSE)

```

In a previous post, we discussed about a package dependency that goes slightly beyond the normal R package ecosystem dependency: R itself.
Today, we step even further and discuss about dependencies that have nothing to do with R: system dependencies.
In particular, we are going to talk about system dependencies in the context of automated testing: is there anything extra to do when setting continuous integration for your package with system dependencies?
How does it work behind the scenes?
And how to work with edge cases?

## Introduction: specifying system dependencies in R packages

Before jumping right into the topic of continuous integration, let's take a moment to introduce, or remind you, how system dependencies are specified in R packages.
You can directly jump to the next session if this concept is fresh in your memory.

Let's imagine we have a package depending on The official 'Writing R Extensions' guide states:

> Dependencies external to the R system should be listed in the 'SystemRequirements' field, possibly amplified in a separate README file.

One important thing to note is that this field contains free text.
As such, to refer to the same piece of software, you could write either one of the following in the package `DESCRIPTION`:

``` yaml
SystemRequirements: ExternalSoftware
```

``` yaml
SystemRequirements: ExternalSoftware 0.1
```

``` yaml
SystemRequirements: lib-externalsoftware
```

## The general case: everything works automagically

If while reading the previous section, you could already sense the problems linked to the fact `SystemRequirements` is a free-text field, fret not!
In the very large majority of cases, setting up continuous integration in an R package with system dependencies is exactly the same as with any other R package.

Using, as often, the supercharged usethis package, you can automatically create the relevant GitHub Actions workflow file in your project [^1]:

[^1]: Alternatively, if you're not using usethis, you can manually copy-paste the relevant GitHub Actions workflow file from the `examples` of the `r-lib/actions` project.

```{r, eval = FALSE}
usethis::use_github_action("check-standard")
```

The result is:

``` yaml
# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: macos-latest,   r: 'release'}
          - {os: windows-latest, r: 'release'}
          - {os: ubuntu-latest,   r: 'devel', http-user-agent: 'release'}
          - {os: ubuntu-latest,   r: 'release'}
          - {os: ubuntu-latest,   r: 'oldrel-1'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v3

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
```

You may notice there is no explicit mention of system dependencies in this file.
Yet, if we use this workflow in an R package with system dependencies, everything will work out-of-the-box in most cases.
So, when are system dependencies installed?
And how the workflow does even know which dependencies to install since the `SystemRequirements` is free text that may not correspond to the exact name of a library?

The magic happens in the `r-lib/actions/setup-r-dependencies` step.
If you want to learn about it, you can read the source code of this step.
It is mostly written in R but it contains a lot of bells and whistles to handle messaging within the GitHub Actions context and as such, it would be too long to go through it line by line in this post.
However, at a glance, you can notice many mentions of the [pak R package](https://pak.r-lib.org/).

If it's the first you're hearing about the pak package, we strongly recommend we go through the [list of the most important pak features](https://pak.r-lib.org/reference/features.html).
It is packed with many very powerful feature.
The specific feature we're interested in here is the automatic install of system dependencies via [`pak::pkg_system_requirements()`](https://pak.r-lib.org/reference/local_system_requirements.html).

We now understand more precisely where the magic happens but it still doesn't explain how pak is able to know which precise piece of software to install from the free text `SystemRequirements` field.
As often when you want to increase your understanding, it is helpful to [read the source](https://blog.r-hub.io/2019/05/14/read-the-source/).
While browsing `pak::pkg_system_requirements()` source code, we see a couple of API calls to <https://packagemanager.posit.co/__api__/repos/sysreqs>.
This API contains the information of which exact software library is necessary for each R package.
For example, if we wanted to know which system library to install to use jsonlite on Ubuntu, we could fetch <https://packagemanager.posit.co/__api__/repos/sysreqs?all=false&pkgname=jsonlite&distribution=ubuntu&release=22.04>

The information delivered by this API is stored in the `rstudio/r-system-requirements` repository

## When it's not working out-of-the-box

### Fix it for everybody by submitting a pull request

### Install system dependencies manually in GitHub Actions

### Using a Docker image in GitHub Actions
