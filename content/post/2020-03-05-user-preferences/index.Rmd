---
slug: user-preferences
title: "Persistent config and data for R packages"
authors:
  - Maëlle Salmon
date: "2020-03-05"
tags:
- package development
output: 
  html_document:
    keep_md: true
---

Does your R package work best with some configuration? 
You probably want it to be easily found by your package.
Does your R package download huge datasets that don't change much on the provider side? 
Maybe you want to save the corresponding data somewhere persistent so that things will go faster during the next R session. 
In this blog post we shall explain how an R package developer can go about using and setting persistent configuration and data on the user's machine.

## User preferences

As written in [Android developer guidance](https://developer.android.com/training/id-auth/identify) and probably every customer service guide ever, _"Everyone likes it when you remember their name."_. 
Everyone probably likes it too when their barista remembers their usual orders. 
As an R package developer, what can you do for your R package to correctly assess user preferences?

### Using options

In R, `options` _Allow the user to set and examine a variety of global options which affect the way in which R computes and displays its results._. For instance, for the usethis package, the [`usethis.quiet` option can control whether usethis is chatty](https://github.com/r-lib/usethis/blob/c0acd1b5e43f03773a5934c1d937bf70b77a2557/principles.md#communicating-with-the-user). Users either:

* write `options(usethis.quiet = TRUE)` at the beginning of a script or directly in the console;

* or write that same line in their [.Rprofile that's loaded before every session](https://rstats.wtf/r-startup.html), which is more persistent. 

Users can use a project-level or more global user-level .Rprofile. 
The use of a project-level .Rprofile overrides the user-level .Rprofile unless the project-level .Rprofile contains the following lines [as mentioned in the `blogdown` book](https://bookdown.org/yihui/blogdown/global-options.html):

```r
# in .Rprofile of the project
if (file.exists('~/.Rprofile')) {
  base::sys.source('~/.Rprofile', envir = environment())
}
# then set project options
```

For more startup tweaks, the user could adopt [the `startup` package](https://cran.r-project.org/web/packages/startup/index.html).

_Note that in tests `usethis` suppresses the chatty behaviour by the use of [`withr::local_options(list(usethis.quiet = FALSE))`](https://github.com/r-lib/usethis/blob/7af1aa2e0ac0b699fdd39f5cfbe4d1ccba41bc48/tests/testthat/test-use-pipe.R#L36)._

The use of options in the .Rprofile startup file is great for workflow packages like `usethis`, `blogdown`, etc., but shouldn't be used for, say, arguments influencing the results of a statistical function.

### Using a config file


### A good default experience

Obviously, on top of letting users set their own preferences, you probably want your package functions to have sensible defaults.

### Asking or guessing?

For basic information such as username, email, GitHub username, the [`whoami` package](https://github.com/r-lib/whoami#readme) does pretty well.

```{r whoami}
whoami::whoami()
whoami::email_address()
```

In particular, for the email address, if the R environment variable `EMAIL` isn't set, `whoami` uses a call to `git` to find Git's global configuration. 
Similarly, the [`gert` package](https://jeroen.cran.dev/gert/) can find and return Git's preferences via [`gert::git_config_global()`](https://jeroen.cran.dev/gert/reference/git_config.html) (although it uses libgit2, not Git directly).

In these cases where packages _guess_ something, their guessing is based on the use of standard locations for such information on different operating systems. 
Unsurprisingly, in the next section, we'll recommend using such standard locations when caching _data_.


## Not so temporary files[^1]

Excellent R-pkg-devel thread https://stat.ethz.ch/pipermail/r-package-devel/2020q1/004854.html

* Startup files (including options in .Rprofile), [pkg environment defined in onLoad](https://github.com/eddelbuettel/anytime/blob/caf5ae8f0824c212ac418eb3a1db3f95097153ed/R/init.R)

* `rappdirs` (which is what `rhub` uses!)


Where to find information without asking (whoami, what batchtools does for the config file).

Where to save information... after asking (in an R package you have to ask)



### from other contexts

Older R-pkg-devel thread, excellent email https://www.mail-archive.com/r-package-devel@r-project.org/msg02460.html (and the title! "Dealing with not so temporary files")

https://developer.android.com/guide/topics/data

https://developer.android.com/jetpack/docs/guide#best-practices "Persist as much relevant and fresh data as possible."



### rappdirs usage

General blabla.

config vs data (I have trouble differentiating all the dirs, but sometimes probably important https://github.com/ropensci/getCRUCLdata/commit/b4a97c41ec741ebe5a694a3983e50aeb1c2a83b0, I'd recommend looking through similar examples **on CRAN** or from another trustworthy source -- e.g. a maintainer you know)

* user_data_dir https://github.com/r-hub/rhub/blob/caa9bf7dddd64c36941f043575d10a6e7af6a7aa/R/email.R#L163 ok because the docs mention it'll be written somewhere.

* config batchtools findConfFile. The user needs to set it up themselves at the moment. https://github.com/mllg/batchtools batchtools also accepts other locations such as _File “batchtools.conf.R” in the path specified by the environment variable "R_BATCHTOOLS_SEARCH_PATH"._

* user_cache_dir https://github.com/cran/getlandsat/blob/0609a329826b44267b8850e947453707a44d3773/R/cache.R

* site_data_dir no CRAN package, user_log_dir same.

Note caveats from rappdirs docs.

Some observations

* Documentation of where things are stored -- transparency

* Asking, compulsory?

* Letting users manage caches from R? (getlandsat for instance)

### rappdirs or not

some package authors "roll their own" cf https://twitter.com/henrikbengtsson/status/1233495999982628865).

what is hoardr

Future developments in base R! https://twitter.com/henrikbengtsson/status/1233487759412809734 why is the R-devel change big https://twitter.com/henrikbengtsson/status/1233496382608199683

## More or less temporary solutions

A bit out-of-scope for this post but nonetheless interesting are solutions for caching results very temporarily, or less temporarily.

### Caching results within an R session

To cache results within an R session, you could use a temporary directory for data.
For any function call you could use `memoise` that supports, well [memoization](https://en.wikipedia.org/wiki/Memoization) which is best explained with an example.

```{r}
time <- memoise::memoise(Sys.time)
time()
Sys.sleep(1)
time()
```

Only the first call to `time()` actually calls `Sys.time()`, after that the results is saved for the entire session unless `memoise::forget()` is called.

### Providing a ready-to-use dataset in a non-CRAN package

If your package depends on the use of a huge dataset, the same for all users, that is by definition too huge for CRAN, you can use [a setup like the one presented by Brooke Anderson and Dirk Eddelbuettel in which the data is packaged up in a separate package not on CRAN](https://journal.r-project.org/archive/2017/RJ-2017-026/index.html).

## Conclusion

In this blog post we presented ways of saving configuration options and data in a not so temporary way in R packages.
We mentioned R startup files (options in .Rprofile and secrets in .Renviron), the `rappdirs` package as well as an exciting similar feature in R devel, the keyring package.

guessing vs asking (rhub guesses, in general however per CRAN policies you need to ask for confirmation)
being too invasive vs easing setup and usage

other things
* data as package 
* caching within the same session = memoising. See also polite package.

[^1]: We're using the [very good email subject by Roy Mendelssohn](https://www.mail-archive.com/r-package-devel@r-project.org/msg02450.html) on [R-pkg-devel](/2019/04/11/r-package-devel/).